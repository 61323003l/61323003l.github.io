<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <!-- favicon -->
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%23ff0000'/><stop offset='100%25' style='stop-color:%23990000'/></linearGradient></defs><rect width='100' height='100' fill='url(%23bg)' rx='15'/><text x='50' y='65' font-family='Arial' font-size='45' font-weight='bold' text-anchor='middle' fill='white'>ğŸï¸</text></svg>">
    <title>FH4 è³½é“ç´€éŒ„ç³»çµ±</title>
    <style>
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(255, 0, 0, 0.5);
            font-size: 2.2em;
            margin-bottom: 30px;
        }

        input, button, select {
            padding: 10px;
            margin: 5px;
            border: 2px solid #ff0000;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
            font-weight: bold;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffff00;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }

        button {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(45deg, #ff4444, #ff6666);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 0, 0, 0.3);
        }

        textarea { display: block; margin: 10px 0; width: 300px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #ff0000;
            padding: 12px 8px;
            text-align: center;
            color: #ffffff;
        }

        th {
            background: linear-gradient(45deg, #ff0000, #cc0000);
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        th:hover {
            background: linear-gradient(45deg, #ff4444, #ff0000);
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background: rgba(255, 0, 0, 0.1);
        }

        .error {
            color: #ffff00;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .backtotop {
            position: fixed;
            right: 30px;
            bottom: 30px;
            background: linear-gradient(45deg, #ff0000, #ff4444);
            border-radius: 50%;
            height: 75px;
            width: 75px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .backtotop:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
        }

        .backtotop img {
            display: block;
            margin: auto;
            max-width: 80%;
            filter: brightness(0) invert(1);
        }

        .topnav {
            position: sticky;
            top: 0;
            background: linear-gradient(90deg, #ff0000 0%, #cc0000 50%, #ff0000 100%);
            list-style-type: none;
            margin: 0 0 30px 0;
            padding: 0;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .topnav::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffff00, #ff0000, #ffff00, #ff0000, #ffff00);
            animation: speedStripe 2s linear infinite;
        }

        @keyframes speedStripe {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .topnav li {
            display: inline-block;
        }

        .topnav a {
            display: inline-block;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 16px 20px;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .topnav a:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .segmented-control {
            display: inline-flex;
            border-radius: 8px;
            background: linear-gradient(45deg, #333, #555);
            padding: 3px;
            margin-left: 15px;
            border: 2px solid #ff0000;
        }

        .segmented-control button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .segmented-control button.active {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .segmented-control button:hover:not(.active) {
            background: rgba(255, 0, 0, 0.2);
            color: white;
        }

        /* è¼¸å…¥å€åŸŸå®¹å™¨æ¨£å¼ */
        div:has(input) {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        /* ç¯©é¸å™¨å€åŸŸæ¨£å¼ */
        div:has(#filterTrack) {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(255, 0, 0, 0.4);
        }

        label {
            color: #ffffff;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
        // å›åˆ°é ‚ç«¯åŠŸèƒ½
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    </script>
</head>

<body>
    <header>
        <h1>FH4 è»Šè¼›ç´€éŒ„ç³»çµ±</h1>
    </header>
    <!-- å›åˆ°é ‚ç«¯æŒ‰éˆ• -->
    <div class="backtotop"><a href="#" onclick="scrollToTop(); return false;"><img src="img\è² é›»æ‹æ‹é ­å‰ªå½±-2.png" alt="å›åˆ°é ‚ç«¯" title="æŒ‰ä¸€ä¸‹å›åˆ°é ‚ç«¯"></a></div>
    <!-- top navigation bar -->
    <div class="topnav">
        <li><a href="https://docs.google.com/spreadsheets/d/1z_vnstW1q7UoFhRYTa4skagDlBoNCPtlobxkiN-m2Dk/edit?gid=710451785#gid=710451785" target="_blank">FH4è³½é“åˆ—è¡¨</a></li>
        <li><a href="https://docs.google.com/spreadsheets/d/1z_vnstW1q7UoFhRYTa4skagDlBoNCPtlobxkiN-m2Dk/edit?gid=1760936330#gid=1760936330" target="_blank">FH4è»Šè¼›åˆ—è¡¨</a></li>
        <li><a href="https://docs.google.com/spreadsheets/d/1z_vnstW1q7UoFhRYTa4skagDlBoNCPtlobxkiN-m2Dk/edit?gid=1034815587#gid=1034815587" target="_blank">èª¿æ•™è»Šè¼›</a></li>
        <li><a href="https://docs.google.com/spreadsheets/d/1z_vnstW1q7UoFhRYTa4skagDlBoNCPtlobxkiN-m2Dk/edit?gid=1632701730#gid=1632701730" target="_blank">è³½é“ç´€éŒ„</a></li>
    </div>
    <div>
        <input list="carList" type="text" id="car" placeholder="è»Šè¼›åç¨±">
        <datalist id="carList"></datalist>
        <input list="trackList" type="text" id="track" placeholder="è³½é“åç¨±">
        <datalist id="trackList"></datalist>
        <input type="text" id="lap" placeholder="å–®åœˆåœˆé€Ÿ (ä¾‹ï¼š05:38.328)">
        <input type="text" id="total" placeholder="è³½é“åœˆé€Ÿ (ä¾‹ï¼š05:38.328)">
        <button id="b" onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
    </div>
    <script>
        // å°‡"æ–°å¢ç´€éŒ„"å¯«å…¥ google sheet
        $(function() {
        var $a1 = $('#car'),
            $a2 = $('#track'),
            $a3 = $('#lap'),
            $a4 = $('#total')
        $b = $('#b'),
            a = {};

        $b.on('click', function() {
            a = {
                data: $a1.val() + ',' + $a2.val() + ',' + $a3.val() + ',' + $a4.val(),
                sheetUrl: 'https://docs.google.com/spreadsheets/d/1z_vnstW1q7UoFhRYTa4skagDlBoNCPtlobxkiN-m2Dk/edit?gid=1632701730#gid=1632701730',
                sheetTag: 'è³½é“ç´€éŒ„'
            };
            console.log(a);
            $.get('https://script.google.com/macros/s/AKfycbxBzCRzG-bDfd1Z-4hRij0daGm6sMT0q49BvZnjr8Cz8gg7SgASGDhAkd61SGlfJx1NNA/exec', a)
                .done(function(response) {
                    // è«‹æ±‚æˆåŠŸå®Œæˆå¾ŒåŸ·è¡Œ
                    console.log("Apps Script å›æ‡‰:", response); // é¡¯ç¤º Apps Script çš„å›æ‡‰

                    // å‡è¨­ Apps Script æœƒè¿”å›ä¸€å€‹ JSON ç‰©ä»¶ï¼Œå…¶ä¸­åŒ…å« success ç‹€æ…‹
                    // æ‚¨éœ€è¦æ ¹æ“š Apps Script çš„å¯¦éš›å›æ‡‰æ ¼å¼èª¿æ•´é€™è£¡çš„åˆ¤æ–·
                    if (response === true || response === "true") { // <--- é—œéµæ”¹è®Šï¼šç›´æ¥åˆ¤æ–· response æ˜¯å¦ç‚º true
                        $('#error-message').text('ç´€éŒ„å·²æˆåŠŸé€å‡ºï¼'); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        // æ¸…ç©ºæ¬„ä½å…§å®¹
                        $a1.val('');//æ¸…ç©ºè»Šè¼›
                        // $a2.val('');//æ¸…ç©ºè³½é“
                        $a3.val('');//æ¸…ç©ºå–®åœˆ
                        $a4.val('');//æ¸…ç©ºç¸½åœˆ
                    } else {
                        // Apps Script å›æ‡‰ä¸æ˜¯ trueï¼Œè¦–ç‚ºå¤±æ•—
                        $('#error-message').text('é€å‡ºå¤±æ•—: Apps Script å›æ‡‰éé æœŸã€‚'); // é¡¯ç¤ºå¤±æ•—è¨Šæ¯
                        console.error("Apps Script è¿”å›éé æœŸå›æ‡‰:", response); // è¨˜éŒ„ä¸‹éé æœŸçš„å›æ‡‰
                    }
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    // è«‹æ±‚å¤±æ•—æ™‚åŸ·è¡Œï¼ˆä¾‹å¦‚ç¶²è·¯å•é¡Œæˆ– Apps Script éŒ¯èª¤ï¼‰
                    console.error("è«‹æ±‚å¤±æ•—:", textStatus, errorThrown);
                    $('#error-message').text('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Apps Script è¨­å®šã€‚');
                });
        });
    });
    </script>
    <div id="error-message" class="error"></div>
    <!-- åœ–ç‰‡è¾¨è­˜åŠŸèƒ½å€ -->
    <img id="preview" style="max-width: 500px; display:none; margin-top: 10px;">
    <script>
        // Google Sheet å‹•æ…‹è¼‰å…¥ è»Šè¼›åç¨±
    let vehicleList = [];

    // åœ¨é é¢è¼‰å…¥æ™‚ç²å–è»Šè¼›åˆ—è¡¨
const GOOGLE_APPS_SCRIPT_VEHICLE_LIST_URL = "https://script.google.com/macros/s/AKfycbxP2dQrjxsMb11ErGxq01zgOJg2g2pkjQlRPSgTsjP021DrxWZtNYeHT4PwL4tGN681lw/exec"; 

async function fetchVehicleList() {
    try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_VEHICLE_LIST_URL, {
            method: 'GET',
            mode: 'cors'
        });
        const result = await response.json();
        if (result.status === "success" && result.data) {
            vehicleList = result.data; // æ›´æ–°å…¨å±€çš„ vehicleList è®Šæ•¸
            console.log("è»Šè¼›åˆ—è¡¨å·²å¾ Google Sheet è¼‰å…¥:", vehicleList);
            updateCarListDatalist(); // æ›´æ–° datalistï¼Œè®“è¼¸å…¥æ¡†èƒ½è‡ªå‹•å®Œæˆ
        } else {
            console.error("è¼‰å…¥è»Šè¼›åˆ—è¡¨å¤±æ•—:", result.message);
            document.getElementById("error-message").innerText = "ç„¡æ³•è¼‰å…¥è»Šè¼›åˆ—è¡¨ï¼š" + result.message;
        }
    } catch (error) {
        console.error("é€£æ¥ Apps Script ç²å–è»Šè¼›åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
        document.getElementById("error-message").innerText = "ç„¡æ³•é€£æ¥åˆ°è»Šè¼›åˆ—è¡¨æœå‹™ã€‚";
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œå‘¼å«
document.addEventListener('DOMContentLoaded', fetchVehicleList);


// æ–°å¢é€™å€‹å‡½æ•¸ä¾†æ›´æ–° datalist
function updateCarListDatalist() {
    const datalist = document.getElementById("carList");
    datalist.innerHTML = Array.from(vehicleList).sort().map(c => `<option value="${c}">`).join("");
}

    function getBestMatch(text, candidates) {
        text = text.toLowerCase();
        let best = '';
        let minDistance = Infinity;
        for (const name of candidates) {
            const dist = levenshtein(text, name.toLowerCase());
            if (dist < minDistance) {
                minDistance = dist;
                best = name;
            }
        }
        return best;
    }

    function levenshtein(a, b) {
        const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
        for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= a.length; i++) {
            for (let j = 1; j <= b.length; j++) {
                const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
            }
        }
        return matrix[a.length][b.length];
    }

    document.addEventListener('paste', async (event) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const url = URL.createObjectURL(blob);
                document.getElementById("preview").src = url;
                document.getElementById("preview").style.display = "block";

                const result = await Tesseract.recognize(blob, 'eng');
                const text = result.data.text;
                console.log("OCRæ–‡å­—å…§å®¹ï¼š", text);

                if (!/dragonwood/i.test(text)) {
                    alert("ä¸æ˜¯æŒ‡å®šç©å®¶çš„åœ–ç‰‡ï¼");
                    return;
                }

                // document.getElementById("player").value = "dragonwood0613";

                // æ™‚é–“åŒ¹é…
                const timeMatch = text.match(/(\d{2}:\d{2}\.\d{3})/g);
                if (timeMatch) {
                    if (timeMatch[0]) document.getElementById("lap").value = timeMatch[0];
                    if (timeMatch[1]) document.getElementById("total").value = timeMatch[1];
                }

                // è»Šè¼›åç¨±æ¨¡ç³Šæ¯”å°
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 4);
                let foundCar = '';
                for (const line of lines) {
                    const guess = getBestMatch(line, vehicleList);
                    if (guess && line.toLowerCase().includes(guess.toLowerCase().split(' ')[0])) {
                        foundCar = guess;
                        break;
                    }
                }
                if (foundCar) document.getElementById("car").value = foundCar;
            }
        }
    });
    </script>
    <!-- è³‡æ–™åŒ¯å‡º & åŒ¯å…¥ -->
    <div>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="importCSV()">åŒ¯å…¥ CSV</button>
        <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
        <button onclick="clearRecords()">åˆªé™¤å…¨éƒ¨è³‡æ–™</button>
    </div>
    <!-- è¡¨æ ¼é¡¯ç¤ºç¯©é¸å™¨ -->
    <div>
        <label for="filterTrack">é¸æ“‡è³½é“ï¼š</label>
        <select id="filterTrack" onchange="renderTable()">
            <option value="">å…¨éƒ¨</option>
        </select>
        <label for="filterCar">é¸æ“‡è»Šè¼›ï¼š</label>
        <select id="filterCar" onchange="renderTable()">
            <option value="">å…¨éƒ¨</option>
        </select>
        <div class="segmented-control">
            <button id="trackMode" class="active" onclick="switchFilterMode('track')">è³½é“æ¨¡å¼</button>
            <button id="carMode" onclick="switchFilterMode('car')">è»Šè¼›æ¨¡å¼</button>
        </div>
    </div>
    <table id="recordTable">
        <thead>
            <tr>
                <th onclick="sortTable('car')">è»Šè¼›åç¨±</th>
                <th onclick="sortTable('track')">è³½é“åç¨±</th>
                <th onclick="sortTable('lapTime')">å–®åœˆåœˆé€Ÿ</th>
                <th onclick="sortTable('trackTime')">è³½é“åœˆé€Ÿ</th>
                <th onclick="sortTable('pr')">PR å€¼</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
    let records = JSON.parse(localStorage.getItem("fh4_records")) || [];
    let sortKey = null;
    let sortAsc = true;

    function saveRecords() {
        localStorage.setItem("fh4_records", JSON.stringify(records));
    }

    function toSeconds(time) {
        // åŸå§‹ç¨‹å¼ç¢¼åªè™•ç† MM:SS.Sï¼Œé€™è£¡ä¿®æ­£ç‚º MM:SS.SSS
        const parts = time.split(/[:.]/).map(parseFloat); // åˆ†å‰²åˆ†é˜ã€ç§’ã€æ¯«ç§’
        if (parts.length === 3) {
            return parts[0] * 60 + parts[1] + parts[2] / 1000;
        }
        // Fallback for MM:SS or other unexpected formats
        return parseFloat(time) || 0;
    }

    function renderTable() {
        const tbody = document.querySelector("#recordTable tbody");
        const filterTrack = document.getElementById("filterTrack").value;
        const filterCar = document.getElementById("filterCar").value;

        let filtered = records.filter(r => {
            return (!filterTrack || r.track === filterTrack) && (!filterCar || r.car === filterCar);
        });

        filtered.forEach(entry => {
            const sameTrack = records.filter(r => r.track === entry.track && r.lapTime);
            const sorted = [...sameTrack].sort((a, b) => toSeconds(a.lapTime) - toSeconds(b.lapTime));
            const index = sorted.findIndex(r => r.car === entry.car && r.lapTime === entry.lapTime);
            if (index !== -1) {
                entry.pr = ((sorted.length - index) / sorted.length * 100).toFixed(1);
            } else {
                entry.pr = "";
            }
        });

        if (sortKey) {
            filtered.sort((a, b) => {
                let va = a[sortKey] || "";
                let vb = b[sortKey] || "";
                if (sortKey === 'lapTime' || sortKey === 'trackTime') {
                    va = toSeconds(va);
                    vb = toSeconds(vb);
                } else if (sortKey === 'pr') {
                    va = parseFloat(va) || 0;
                    vb = parseFloat(vb) || 0;
                }
                return sortAsc ? va - vb : vb - va;
            });
        }

        tbody.innerHTML = "";
        filtered.forEach(record => {
            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${record.car}</td>
        <td>${record.track}</td>
        <td>${record.lapTime}</td>
        <td>${record.trackTime}</td>
        <td>${record.pr || ""}</td>
        `;
            tbody.appendChild(row);
        });


        updateFilters();
        updateTrackList();
        updateCarList(); // âœ… åŠ å…¥é€™è¡Œ
    }

    function updateFilters() {
        const trackSet = new Set(records.map(r => r.track));
        const carSet = new Set(records.map(r => r.car));
        const trackSelect = document.getElementById("filterTrack");
        const carSelect = document.getElementById("filterCar");

        function updateOptions(select, set) {
            const value = select.value;
            select.innerHTML = '<option value="">å…¨éƒ¨</option>' +
                Array.from(set).sort().map(v => `<option value="${v}">${v}</option>`).join("");
            select.value = value;
        }

        updateOptions(trackSelect, trackSet);
        updateOptions(carSelect, carSet);
    }

    function updateTrackList() {
        const trackSet = new Set(records.map(r => r.track));
        const datalist = document.getElementById("trackList");
        datalist.innerHTML = Array.from(trackSet).sort().map(t => `<option value="${t}">`).join("");
    }

    function updateCarList() {
        const carSet = new Set(records.map(r => r.car));
        const datalist = document.getElementById("carList");
        datalist.innerHTML = Array.from(carSet).sort().map(c => `<option value="${c}">`).join("");
    }

    function addRecord() {
        const car = document.getElementById("car").value.trim();
        const track = document.getElementById("track").value.trim();
        const lapTime = document.getElementById("lap").value.trim();
        const trackTime = document.getElementById("total").value.trim();

        document.getElementById("error-message").innerText = "";

        if (!car || !track || !lapTime || !trackTime) {
            return document.getElementById("error-message").innerText = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚";
        }

        const timeFormat = /^(\d{1,2}):(\d{2})\.(\d{3})$/;
        if (!timeFormat.test(lapTime) || !timeFormat.test(trackTime)) {
            return document.getElementById("error-message").innerText = "åœˆé€Ÿæ ¼å¼éŒ¯èª¤ï¼Œæ‡‰ç‚º MM:SS.SSS æ ¼å¼ã€‚";
        }

        // å°‡è³‡æ–™æ·»åŠ åˆ° records é™£åˆ— (æœ¬åœ°å„²å­˜)
        records.push({ car, track, lapTime, trackTime });
        saveRecords(); // ä¿å­˜ records åˆ° localStorage

        // æ ¹æ“šç¯©é¸æ¨¡å¼è‡ªå‹•è¨­å®šç¯©é¸å™¨
        if (filterMode === "track") {
            document.getElementById("filterTrack").value = track;
            document.getElementById("filterCar").value = "";
        } else {
            document.getElementById("filterCar").value = car;
            document.getElementById("filterTrack").value = "";
        }

        renderTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼


        // æç¤ºè¨Šæ¯å°‡ç”± sendRecordToGoogleSheet è™•ç†ï¼Œé€™è£¡å¯ä»¥ç§»é™¤æˆ–èª¿æ•´
        // document.getElementById("error-message").innerText = "ç´€éŒ„æ–°å¢æˆåŠŸï¼"; 

    }

    function clearRecords() {
        // æé†’ä½¿ç”¨è€…é€™åªæœƒåˆªé™¤æœ¬åœ°è³‡æ–™ï¼Œä¸æœƒå½±éŸ¿ Google è©¦ç®—è¡¨
        if (confirm("ç¢ºå®šè¦åˆªé™¤å…¨éƒ¨æœ¬åœ°è³‡æ–™å—ï¼Ÿé€™ä¸æœƒåˆªé™¤ Google è©¦ç®—è¡¨ä¸­çš„è³‡æ–™ã€‚")) {
            records = [];
            saveRecords();
            renderTable();
            document.getElementById("error-message").innerText = "æœ¬åœ°è³‡æ–™å·²åˆªé™¤ã€‚";
        }
    }

    function importCSV() {
        const file = document.getElementById("csvInput").files[0];
        if (!file) return alert("è«‹é¸æ“‡ CSV æª”æ¡ˆã€‚");

        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split("\n").map(line => line.trim()).filter(line => line);

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(",");
                if (values.length >= 4) {
                    const car = values[0].trim();
                    const track = values[1].trim();
                    const lapTime = values[2].trim();
                    const trackTime = values[3].trim();

                    const timeFormat = /^(\d{2}):(\d{2})\.(\d{3})$/;
                    if (timeFormat.test(lapTime) && timeFormat.test(trackTime)) {
                        records.push({ car, track, lapTime, trackTime });
                    }
                }
            }

            saveRecords();
            renderTable();
            document.getElementById("error-message").innerText = "CSV è³‡æ–™åŒ¯å…¥å®Œæˆã€‚"; // æ–°å¢æˆåŠŸæç¤º
        };
        reader.readAsText(file);
    }

    function exportCSV() {
        if (records.length === 0) {
            return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
        }

        let csvContent = "è»Šè¼›åç¨±,è³½é“åç¨±,å–®åœˆåœˆé€Ÿ,è³½é“åœˆé€Ÿ\n";
        records.forEach(record => {
            const row = [record.car, record.track, record.lapTime, record.trackTime].join(",");
            csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "FH4_è»Šè¼›ç´€éŒ„.csv");
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        document.getElementById("error-message").innerText = "è³‡æ–™å·²åŒ¯å‡ºç‚º CSVã€‚"; // æ–°å¢æˆåŠŸæç¤º

    }

    function sortTable(key) {
        sortKey = key;
        sortAsc = !sortAsc;
        renderTable();
    }

    renderTable();

    // ç¯©é¸æ¨¡å¼ç®¡ç†
    let filterMode = localStorage.getItem("fh4_filter_mode") || "track";

    // åˆå§‹åŒ–ç¯©é¸æ¨¡å¼
    function initFilterMode() {
        const trackBtn = document.getElementById("trackMode");
        const carBtn = document.getElementById("carMode");

        if (filterMode === "track") {
            trackBtn.classList.add("active");
            carBtn.classList.remove("active");
        } else {
            carBtn.classList.add("active");
            trackBtn.classList.remove("active");
        }
    }

    // åˆ‡æ›ç¯©é¸æ¨¡å¼
    function switchFilterMode(mode) {
        filterMode = mode;
        localStorage.setItem("fh4_filter_mode", mode);

        const trackBtn = document.getElementById("trackMode");
        const carBtn = document.getElementById("carMode");

        if (mode === "track") {
            trackBtn.classList.add("active");
            carBtn.classList.remove("active");
        } else {
            carBtn.classList.add("active");
            trackBtn.classList.remove("active");
        }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initFilterMode();
    });
    </script>
</body>

</html>