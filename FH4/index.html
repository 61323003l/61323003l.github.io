<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <!-- favicon -->
    <link rel="shortcut icon" href="img\DWU icon.ico">
    <title>FH4 賽道紀錄系統</title>
    <style>
        body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    h1 {
      text-align: center;
    }

    input,
    button,
    select {
      padding: 6px;
      margin: 5px;
    }

    textarea { display: block; margin: 10px 0; width: 300px; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #eee;
      cursor: pointer;
    }

    .error {
      color: red;
      font-size: 14px;
    }

    /*  回到頂端按鈕  */
.backtohome {
    position: fixed;
    right: 30px;
    bottom: 30px;
    /*       background-color: #75c0ea;*/
    border-radius: 30px;
    height: 75px;
    width: 75px;
}

.backtohome img {
    display: block;
    margin: auto;
    max-width: 80%;
    /*filter: drop-shadow(1px 1px 1px);*/
}
  </style>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>

<body>
    <h1>FH4 車輛紀錄系統</h1>
    <!-- 回到頂端按鈕 -->
    <div class="backtohome"><a href="https://61323003l.github.io/MyWebsite/"><img src="img\負電拍拍頭剪影-2.png" alt="回到首頁" title="按一下回到首頁"></a></div>
    <div>
        <input list="carList" type="text" id="car" placeholder="車輛名稱">
        <datalist id="carList"></datalist>
        <input list="trackList" type="text" id="track" placeholder="賽道名稱">
        <datalist id="trackList"></datalist>
        <input type="text" id="lap" placeholder="單圈圈速 (例：05:38.328)">
        <input type="text" id="total" placeholder="賽道圈速 (例：05:38.328)">
        <button onclick="addRecord()">新增紀錄</button>
        <div id="error-message" class="error"></div>
    </div>
    <!-- 圖片辨識功能區 -->
    <img id="preview" style="max-width: 500px; display:none; margin-top: 10px;">
    <script>
        const vehicleList = [
        "Bugatti EB110", "Ford GT '05", "Honda NSX-R '92", "Corvette '09", "Maseratti MC12", "McLaren 570S",
        "McLaren F1", "Nissan GT-R '97", "Dodge Viper '08", "Corvette '02", "Lambo Huracán", "Ford Focus '17",
        "Ferrari 458", "McLaren 12C", "Porsche Cayman", "Alfa Romeo 4C", "Koenigsegg CC8S", "M-B AMG GTR",
        "Vantage S '13", "Aventador J", "Pagani Zonda C", "Porsche 911 '19", "Porsche Carrera",
        "Koenigsegg CCGT", "Pagani Zonda R", "Ferrari F40 C", "Ferrari F50 GT", "Ferrari 599XX E", "Ferrari FXX",
        "M-B CLK-GTR", "Apollo IE '18", "WP FERRARI F50", "DIABLO GTR", "Lotus Elise GT1", "CORVETTE C8 '20",
        "Ford Mustang DD", "Alfa Romeo 33S", "WP #1 TOYOTA T100", "Jeep Trailcat", "RAM Rebel TRX",
        "Atomic Punk '59", "Nova '69 FE", "Alfa Romeo TZ2", "Ford Roadster", "Ford Raptor '17", "M-B X-Class",
        "Chevrolet ZR2", "Macan Turbo '19", "Jaguar F-PACE S", "Abarth 131", "Alfa Romeo GTA", "Datsun 510",
        "IH Scout 800A", "MINI '65", "Shelby Daytona", "Honda Civic '74", "Subaru Legacy RS", "RAM Power Wagon",
        "Shelby Monaco KC", "Pagani Huayra BC", "Bugatti Divo", "Lambo Centenario", "McLaren Senna", "BAC Mono",
        "LEXUS LFA", "Hoonigan RS200", "Mazda RX-7 '97", "Subaru 22B", "Lancer GSR '99", "Nissan GT-R '02",
        "Honda S2000", "BMW M6 '13 FE", "KTM X-Bow GT4", "Ferrari FXX K", "AM Vulcan FE", "GTA Spano",
        "Aventador FE", "McLaren P1", "911 GT2 RS '18", "Lambo Sesto", "RAESR TS '19", "BMW M4 '14",
        "Acura NSX '17", "Audi R8 '13", "Chevy Camaro '15", "Challenger '15", "Dodge Charger '15", "Ford Mustang '16",
        "WP FOCUS RS RX", "Jaguar C-X75", "M-B SLS AMG", "Subaru BRZ", "Saleen S5S", "Nissan GT-R '12",
        "Honda Civic '97", "M-B C63"
    ];

    function getBestMatch(text, candidates) {
        text = text.toLowerCase();
        let best = '';
        let minDistance = Infinity;
        for (const name of candidates) {
            const dist = levenshtein(text, name.toLowerCase());
            if (dist < minDistance) {
                minDistance = dist;
                best = name;
            }
        }
        return best;
    }

    function levenshtein(a, b) {
        const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
        for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= a.length; i++) {
            for (let j = 1; j <= b.length; j++) {
                const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
            }
        }
        return matrix[a.length][b.length];
    }

    document.addEventListener('paste', async (event) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf("image") === 0) {
                const blob = item.getAsFile();
                const url = URL.createObjectURL(blob);
                document.getElementById("preview").src = url;
                document.getElementById("preview").style.display = "block";

                const result = await Tesseract.recognize(blob, 'eng');
                const text = result.data.text;
                console.log("OCR文字內容：", text);

                if (!/dragonwood/i.test(text)) {
                    alert("不是指定玩家的圖片！");
                    return;
                }

                // document.getElementById("player").value = "dragonwood0613";

                // 時間匹配
                const timeMatch = text.match(/(\d{2}:\d{2}\.\d{3})/g);
                if (timeMatch) {
                    if (timeMatch[0]) document.getElementById("lap").value = timeMatch[0];
                    if (timeMatch[1]) document.getElementById("total").value = timeMatch[1];
                }

                // 車輛名稱模糊比對
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 4);
                let foundCar = '';
                for (const line of lines) {
                    const guess = getBestMatch(line, vehicleList);
                    if (guess && line.toLowerCase().includes(guess.toLowerCase().split(' ')[0])) {
                        foundCar = guess;
                        break;
                    }
                }
                if (foundCar) document.getElementById("car").value = foundCar;
            }
        }
    });
    </script>
    <!-- 資料匯出 & 匯入 -->
    <div>
        <input type="file" id="csvInput" accept=".csv">
        <button onclick="importCSV()">匯入 CSV</button>
        <button onclick="exportCSV()">匯出 CSV</button>
        <button onclick="clearRecords()">刪除全部資料</button>
    </div>
    <div>
        <label for="filterTrack">選擇賽道：</label>
        <select id="filterTrack" onchange="renderTable()">
            <option value="">全部</option>
        </select>
        <label for="filterCar">選擇車輛：</label>
        <select id="filterCar" onchange="renderTable()">
            <option value="">全部</option>
        </select>
    </div>
    <table id="recordTable">
        <thead>
            <tr>
                <th onclick="sortTable('car')">車輛名稱</th>
                <th onclick="sortTable('track')">賽道名稱</th>
                <th onclick="sortTable('lapTime')">單圈圈速</th>
                <th onclick="sortTable('trackTime')">賽道圈速</th>
                <th onclick="sortTable('pr')">PR 值</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
    let records = JSON.parse(localStorage.getItem("fh4_records")) || [];
    let sortKey = null;
    let sortAsc = true;

    function saveRecords() {
        localStorage.setItem("fh4_records", JSON.stringify(records));
    }

    function toSeconds(time) {
        // 原始程式碼只處理 MM:SS.S，這裡修正為 MM:SS.SSS
        const parts = time.split(/[:.]/).map(parseFloat); // 分割分鐘、秒、毫秒
        if (parts.length === 3) {
            return parts[0] * 60 + parts[1] + parts[2] / 1000;
        }
        // Fallback for MM:SS or other unexpected formats
        return parseFloat(time) || 0;
    }

    function renderTable() {
        const tbody = document.querySelector("#recordTable tbody");
        const filterTrack = document.getElementById("filterTrack").value;
        const filterCar = document.getElementById("filterCar").value;

        let filtered = records.filter(r => {
            return (!filterTrack || r.track === filterTrack) && (!filterCar || r.car === filterCar);
        });

        filtered.forEach(entry => {
            const sameTrack = records.filter(r => r.track === entry.track && r.lapTime);
            const sorted = [...sameTrack].sort((a, b) => toSeconds(a.lapTime) - toSeconds(b.lapTime));
            const index = sorted.findIndex(r => r.car === entry.car && r.lapTime === entry.lapTime);
            if (index !== -1) {
                entry.pr = ((sorted.length - index) / sorted.length * 100).toFixed(1);
            } else {
                entry.pr = "";
            }
        });

        if (sortKey) {
            filtered.sort((a, b) => {
                let va = a[sortKey] || "";
                let vb = b[sortKey] || "";
                if (sortKey === 'lapTime' || sortKey === 'trackTime') {
                    va = toSeconds(va);
                    vb = toSeconds(vb);
                } else if (sortKey === 'pr') {
                    va = parseFloat(va) || 0;
                    vb = parseFloat(vb) || 0;
                }
                return sortAsc ? va - vb : vb - va;
            });
        }

        tbody.innerHTML = "";
        filtered.forEach(record => {
            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${record.car}</td>
        <td>${record.track}</td>
        <td>${record.lapTime}</td>
        <td>${record.trackTime}</td>
        <td>${record.pr || ""}</td>
        `;
            tbody.appendChild(row);
        });


        updateFilters();
        updateTrackList();
        updateCarList(); // ✅ 加入這行
    }

    function updateFilters() {
        const trackSet = new Set(records.map(r => r.track));
        const carSet = new Set(records.map(r => r.car));
        const trackSelect = document.getElementById("filterTrack");
        const carSelect = document.getElementById("filterCar");

        function updateOptions(select, set) {
            const value = select.value;
            select.innerHTML = '<option value="">全部</option>' +
                Array.from(set).sort().map(v => `<option value="${v}">${v}</option>`).join("");
            select.value = value;
        }

        updateOptions(trackSelect, trackSet);
        updateOptions(carSelect, carSet);
    }

    function updateTrackList() {
        const trackSet = new Set(records.map(r => r.track));
        const datalist = document.getElementById("trackList");
        datalist.innerHTML = Array.from(trackSet).sort().map(t => `<option value="${t}">`).join("");
    }

    function updateCarList() {
        const carSet = new Set(records.map(r => r.car));
        const datalist = document.getElementById("carList");
        datalist.innerHTML = Array.from(carSet).sort().map(c => `<option value="${c}">`).join("");
    }

    function addRecord() {
        const car = document.getElementById("car").value.trim();
        const track = document.getElementById("track").value.trim();
        const lapTime = document.getElementById("lap").value.trim();
        const trackTime = document.getElementById("total").value.trim();

        document.getElementById("error-message").innerText = "";

        if (!car || !track || !lapTime || !trackTime) {
            return document.getElementById("error-message").innerText = "請填寫所有欄位。";
        }

        const timeFormat = /^(\d{1,2}):(\d{2})\.(\d{3})$/;
        if (!timeFormat.test(lapTime) || !timeFormat.test(trackTime)) {
            return document.getElementById("error-message").innerText = "圈速格式錯誤，應為 MM:SS.SSS 格式。";
        }

        records.push({ car, track, lapTime, trackTime });
        saveRecords();
        renderTable();

        document.getElementById("car").value = "";
        document.getElementById("track").value = "";
        document.getElementById("lap").value = "";
        document.getElementById("total").value = "";
        document.getElementById("error-message").innerText = "紀錄新增成功！"; // 新增成功提示

    }

    function clearRecords() {
        if (confirm("確定要刪除全部資料嗎？")) {
            records = [];
            saveRecords();
            renderTable();
        }
    }

    function importCSV() {
        const file = document.getElementById("csvInput").files[0];
        if (!file) return alert("請選擇 CSV 檔案。");

        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split("\n").map(line => line.trim()).filter(line => line);

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(",");
                if (values.length >= 4) {
                    const car = values[0].trim();
                    const track = values[1].trim();
                    const lapTime = values[2].trim();
                    const trackTime = values[3].trim();

                    const timeFormat = /^(\d{2}):(\d{2})\.(\d{3})$/;
                    if (timeFormat.test(lapTime) && timeFormat.test(trackTime)) {
                        records.push({ car, track, lapTime, trackTime });
                    }
                }
            }

            saveRecords();
            renderTable();
            document.getElementById("error-message").innerText = "CSV 資料匯入完成。"; // 新增成功提示
        };
        reader.readAsText(file);
    }

    function exportCSV() {
        if (records.length === 0) {
            return alert("目前沒有資料可以匯出。");
        }

        let csvContent = "車輛名稱,賽道名稱,單圈圈速,賽道圈速\n";
        records.forEach(record => {
            const row = [record.car, record.track, record.lapTime, record.trackTime].join(",");
            csvContent += row + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "FH4_車輛紀錄.csv");
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        document.getElementById("error-message").innerText = "資料已匯出為 CSV。"; // 新增成功提示

    }

    function sortTable(key) {
        sortKey = key;
        sortAsc = !sortAsc;
        renderTable();
    }

    renderTable();
    </script>
</body>

</html>