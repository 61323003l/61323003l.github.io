# 賽道紀錄系統專案設定文件

## 專案概述
- **專案名稱**：FH4 賽道紀錄系統
- **當前版本**：v2.4
- **開發語言**：HTML/CSS/JavaScript + 外部服務
- **主要功能**：車輛賽道記錄管理、OCR圖片識別、Google Sheets整合
- **目標平台**：現代網頁瀏覽器 (支援ES6+)

## AI 協作工作流程偏好

### 修改方式要求
- ❌ **禁止**：直接更新整個 .html 文件
- ✅ **要求**：
  1. 先分析問題並提供修改方案選項
  2. 等待用戶選擇方案後，再提供具體修改步驟
  3. 說明修改的具體位置和代碼內容

### 版本管理要求
- 每次修改都要進行版本編號（v2.1, v2.2, v2.3...）
- 說明每個版本的變更內容和新增功能
- 保持向下兼容性

### 回答格式偏好
- 先提供 2-3 個解決方案讓用戶選擇
- 避免直接執行修改，等待用戶確認
- 提供精確的修改位置（行號或CSS選擇器）
- 清楚標示要新增、修改或刪除的代碼

## 專案技術規範

### 🏗️ 系統整體架構
```
FH4 賽道紀錄系統
├── 前端界面 (HTML/CSS/JS)
├── 數據儲存 (localStorage + Google Sheets)
├── 外部服務整合 (OCR + Google Apps Script)
└── 數據處理 (排序/篩選/匯入匯出)
```

### 📋 核心功能模組

#### **1. 數據管理模組**
- **本地儲存**: localStorage 存儲記錄數據
- **雲端同步**: Google Sheets 雙向同步整合
- **數據結構**: `{car, track, lapTime, trackTime, pr}`
- **雲端載入**: 自動獲取雲端所有記錄
- **資料去重**: 智能合併本地與雲端資料

#### **2. 記錄輸入模組**
- **手動輸入**: 車輛名稱、賽道名稱、單圈/總圈時間
- **自動完成**: 動態載入車輛列表 (Google Sheets)
- **OCR識別**: 貼上圖片自動識別文字內容
- **數據驗證**: 時間格式驗證 (MM:SS.SSS)

#### **3. 數據展示模組**
- **表格顯示**: 可排序的記錄列表
- **篩選功能**: 按車輛/賽道篩選
- **PR計算**: 自動計算百分位排名
- **排序功能**: 多欄位升降序排列
- **篩選重置**: 一鍵清除所有篩選條件

#### **4. 數據處理模組**
- **CSV匯入**: 批量導入記錄
- **CSV匯出**: 備份數據
- **時間轉換**: MM:SS.SSS 格式處理
- **模糊匹配**: 車輛名稱智能匹配（Levenshtein距離算法）

#### **5. 用戶界面模組**
- **響應式設計**: 適配不同屏幕尺寸
- **頂部導航**: Google Sheets 快速連結
- **回到頂端**: 平滑滾動功能
- **錯誤提示**: 用戶操作反饋

### 🔌 外部服務整合

#### **Google Apps Script API**
```javascript
// 車輛列表獲取
VEHICLE_LIST_URL: "https://script.google.com/macros/s/AKfycbxP2dQrjxsMb11ErGxq01zgOJg2g2pkjQlRPSgTsjP021DrxWZtNYeHT4PwL4tGN681lw/exec"

// 記錄寫入
RECORD_SUBMIT_URL: "https://script.google.com/macros/s/AKfycbxBzCRzG-bDfd1Z-4hRij0daGm6sMT0q49BvZnjr8Cz8gg7SgASGDhAkd61SGlfJx1NNA/exec"

// 記錄讀取
FETCH_RECORDS_URL: "RECORD_SUBMIT_URL?action=fetchRecords"

#### **OCR服務配置**
```javascript
// Tesseract.js 設定
- 語言支援: 英文 ('eng')
- 玩家驗證: 檢查文字內容包含 "dragonwood"
- 自動提取: 時間格式 (MM:SS.SSS)
- 智能匹配: 車輛名稱模糊比對
```

### 📊 數據流程架構

#### **記錄新增流程**
```
用戶輸入 → 數據驗證 → 本地儲存 → Google Sheets同步 → 界面更新
```

#### **雲端同步流程**
```
點擊重新整理 → 獲取雲端資料 → 與本地資料合併去重 → 更新本地儲存 → 重新渲染表格
```

#### **OCR處理流程**
```
圖片貼上 → OCR識別 → 玩家驗證 → 數據提取 → 自動填入表單
```

#### **數據查詢流程**
```
篩選條件 → 本地數據過濾 → PR計算 → 排序處理 → 表格渲染
```

#### **篩選重置流程**
```
點擊清除篩選 → 重置所有篩選器 → 重新渲染表格 → 顯示操作確認
```

### 🎯 技術棧說明

#### **前端技術**
- **HTML5**: 語義化標籤結構、Clipboard API
- **CSS3**: 響應式布局、Flexbox、圓角設計
- **JavaScript ES6+**: 現代語法、async/await、模組化

#### **外部依賴庫**
- **jQuery 1.9.1**: DOM操作和AJAX請求
- **Tesseract.js 2.1.5**: OCR圖片文字識別

#### **外部服務**
- **Google Apps Script**: 後端API服務
- **Google Sheets**: 數據存儲和車輛列表管理

#### **瀏覽器API使用**
- **localStorage**: 本地數據持久化
- **Clipboard API**: 圖片貼上處理
- **File API**: CSV檔案讀取
- **Fetch API**: 網路請求（車輛列表獲取）

### 📐 數據格式規範

#### **時間格式**
```javascript
正規表達式: /^(\d{1,2}):(\d{2})\.(\d{3})$/
範例: "05:38.328" (分:秒.毫秒)
```

#### **記錄結構**
```javascript
{
  car: String,        // 車輛名稱
  track: String,      // 賽道名稱
  lapTime: String,    // 單圈圈速 (MM:SS.SSS)
  trackTime: String,  // 賽道圈速 (MM:SS.SSS)
  pr: Number          // 百分位排名 (動態計算)
}
```

### 代碼結構要求
- **單一HTML檔案**: 所有CSS、JavaScript內嵌
- **模組化JavaScript**: 功能分離的函數設計
- **響應式CSS**: 支援桌面和移動設備
- **無需外部資源**: 除CDN依賴外自包含

### 已知限制說明
- **OCR限制**: 僅支援英文識別，需要清晰圖片品質
- **網路依賴**: 需要網路連線存取Google Services
- **瀏覽器要求**: 需支援ES6語法和現代Web API

## 新對話開始時的使用說明

### 使用此設定文件的方法：
1. 上傳當前版本的 .html 文件
2. 同時提供此專案設定文件
3. 在對話開始時說明：「請按照專案設定文件中的工作流程偏好進行協作」

### 版本同步提醒：
- 如果進行了多次修改，建議每 3-5 個功能更新後重新上傳當前版本
- 在新對話中說明已完成的修改內容，避免建議過時的修改方案

## 版本更新記錄

### v2.1 (2025-08-19)
- 回到頂端按鈕修改
- 新增記錄後保留賽道名稱  
- 新增記錄後自動篩選與顯示賽道排名

### v2.2 (2025-08-24)
- 新增篩選模式切換功能（分段控制器樣式）
- 支援「賽道模式」和「車輛模式」兩種自動篩選
- 用戶偏好記憶功能（localStorage儲存）
- 現代化UI設計，與原有界面完美融合

### v2.3 (2025-08-24)
- UI全面改版：賽車主題風格設計
- 新增漸層背景和賽車風格配色（紅黑主題）
- 更新favicon為賽車圖標配合主題
- 優化導航欄視覺效果（彩色速度條裝飾）
- 增強按鈕和表格的賽車風格設計

### v2.4 (2025-08-24)
- 新增雲端資料同步功能
- 實作「重新整理」按鈕載入Google Sheets資料
- 智能資料去重合併機制（車輛+賽道+單圈+總圈完全匹配）
- 雲端與本地資料無縫整合
- 完整的同步狀態提示與錯誤處理
- 新增「清除篩選」按鈕重置所有篩選條件
- Google Apps Script新增fetchAllRecords端點

### v2.5 (2025-08-24) 
- UI優化：篩選器區域重新布局
- 新增清除篩選功能的用戶反饋提示
- 完善篩選器操作體驗

### 規劃中功能 (v2.6+)
- [ ] 數據統計圖表
- [ ] 深色/淺色模式切換
- [ ] 記錄編輯功能
- [ ] 批量操作介面

---
**最後更新**：2025-08-24
**文件版本**：2.1 → 2.5